/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package edu.duke.ece568;

import edu.duke.ece568.communication.amazon.AmazonCommunicator;
import edu.duke.ece568.communication.world.WorldCommunicator;
import edu.duke.ece568.proto.WorldUps;
import edu.duke.ece568.utils.AmazonConnector;
import edu.duke.ece568.utils.WorldConnect;

import java.io.IOException;

import static edu.duke.ece568.utils.GPBHelper.sendMsgTo;

public class App {
    final String WORLD_HOST = "45.77.144.105";
    final int WORLD_PORT = 12345;
    final int AMAZON_PORT = 12345;

    private WorldConnect worldConnector;
    private WorldCommunicator worldCommunicator;
    private AmazonConnector amazonConnector;
    private AmazonCommunicator amazonCommunicator;


    public App(){//TODO pass hosts and ports info

    }

    /**
     * Connects to world/Connects to amazon
     * @throws IOException
     */
    public void setup() throws IOException {
        // Setup World Connection
        worldConnector = new WorldConnect(WORLD_HOST, WORLD_PORT);
        worldConnector.setupConnection();

        // Setup World speed
        WorldUps.UCommands.Builder worldSpeed =  WorldUps.UCommands.newBuilder().setSimspeed(10);
        sendMsgTo(worldSpeed.build(), worldConnector.getWorld_socket().getOutputStream());

        // Setup Amazon Connection
        amazonConnector = new AmazonConnector(AMAZON_PORT, worldConnector.getWorldid());
        amazonConnector.connectAmazon_socket();

        // Send worldID to Amazon
        amazonConnector.processWorldMsg();

        // Setup Amazon Communicator Thread
        amazonCommunicator =  new AmazonCommunicator(amazonConnector.getAmazon_socket());
        worldCommunicator = new WorldCommunicator(worldConnector.getWorld_socket(), amazonCommunicator);
        amazonCommunicator.setWorldCommunicator(worldCommunicator);
    }

    public void run(){
        // Run AmazonCommunicator threads
        amazonCommunicator.runThreads();

        // Run WorldCommunicator threads
        worldCommunicator.runThreads();

        // inf loops
        while (true){}
    }


    public static void main(String[] args) throws IOException, InterruptedException {
        App app = new App();
        app.setup();
        app.run();
    }
}
